<Project>

  <PropertyGroup>
    <BeforeBlazorWasmPrerendering>$(BeforeBlazorWasmPrerendering)</BeforeBlazorWasmPrerendering>
  </PropertyGroup>

  <!-- Define Properties -->
  <Target Name="BlazorWasmPrerendering_DefineProperties" DependsOnTargets="$(BeforeBlazorWasmPrerendering)">
    <PropertyGroup>
      <BlazorWasmPrerenderingTFM Condition=" '$(BlazorWasmPrerenderingTFM)' == '' AND $(TargetFramework.StartsWith('net5')) ">net5.0</BlazorWasmPrerenderingTFM>
      <BlazorWasmPrerenderingTFM Condition=" '$(BlazorWasmPrerenderingTFM)' == '' AND $(TargetFramework.StartsWith('net6')) ">net6.0</BlazorWasmPrerenderingTFM>
      <BlazorWasmPrerenderingTFM Condition=" '$(BlazorWasmPrerenderingTFM)' == '' AND $(TargetFramework.StartsWith('net7')) ">net7.0</BlazorWasmPrerenderingTFM>
      <BlazorWasmPrerenderingPublishDir Condition=" '$(BlazorWasmPrerenderingPublishDir)' == '' ">$([System.IO.Path]::GetFullPath('$(PublishDir)').TrimEnd('\').TrimEnd('/'))</BlazorWasmPrerenderingPublishDir>
      <BlazorWasmPrerenderingAssembly Condition=" '$(BlazorWasmPrerenderingAssembly)' == '' ">$(AssemblyName)</BlazorWasmPrerenderingAssembly>
      <BlazorWasmPrerenderingRootComponentType Condition=" '$(BlazorWasmPrerenderingRootComponentType)' == '' ">$(RootNamespace).App</BlazorWasmPrerenderingRootComponentType>
      <BlazorWasmPrerenderingRootComponentSelector Condition=" '$(BlazorWasmPrerenderingRootComponentSelector)' == '' ">#app,app</BlazorWasmPrerenderingRootComponentSelector>
      <BlazorWasmPrerenderingHeadOutletComponentSelector Condition=" '$(BlazorWasmPrerenderingHeadOutletComponentSelector)' == '' ">head::after</BlazorWasmPrerenderingHeadOutletComponentSelector>
      <BlazorWasmPrerenderingServerDll Condition=" '$(BlazorWasmPrerenderingServerDll)' == '' ">$(MSBuildThisFileDirectory)../tools/$(BlazorWasmPrerenderingTFM)/blazorwasm-prerendering-server.dll</BlazorWasmPrerenderingServerDll>
      <BlazorWasmPrerenderingIntermediateDir Condition=" '$(BlazorWasmPrerenderingIntermediateDir)' == '' ">$(ProjectDir)$(IntermediateOutputPath).</BlazorWasmPrerenderingIntermediateDir>
      <BlazorWasmPrerenderingMiddlewareArg Condition=" '$(BlazorWasmPrerenderingMiddlewarePackages)' == '' ">@(BlazorWasmPrerenderMiddleware->'%(Identity),%(Assembly),%(Version)')</BlazorWasmPrerenderingMiddlewareArg>
      <BlazorWasmPrerenderingEnvironment Condition=" '$(BlazorWasmPrerenderingEnvironment)' == '' ">Prerendering</BlazorWasmPrerenderingEnvironment>
      <BlazorWasmPrerenderingOutputStyle Condition=" '$(BlazorWasmPrerenderingOutputStyle)' == '' ">IndexHtmlInSubFolders</BlazorWasmPrerenderingOutputStyle>
      <BlazorWasmPrerenderingKeepServer Condition=" '$(BlazorWasmPrerenderingKeepServer)' == '' ">false</BlazorWasmPrerenderingKeepServer>
      <BlazorWasmPrerenderingKeepServerSwitch Condition=" '$(BlazorWasmPrerenderingKeepServer)' == 'true' ">-k</BlazorWasmPrerenderingKeepServerSwitch>
    </PropertyGroup>
  </Target>

  <Target Name="PrepareBlazorWasmPrerendering" AfterTargets="Build" Condition=" '$(BlazorWasmPrerendering)' != 'disable' ">
    <PropertyGroup>
      <BlazorWasmPrerenderingPrevPublishDir Condition=" '$(BlazorWasmPrerenderingPrevPublishDir)' == '' ">$([System.IO.Path]::GetFullPath('$(PublishDir)').TrimEnd('\').TrimEnd('/'))</BlazorWasmPrerenderingPrevPublishDir>
    </PropertyGroup>
    <Delete Files="$(BlazorWasmPrerenderingPrevPublishDir)/wwwroot/index.html" />
    <Delete Files="$(BlazorWasmPrerenderingPrevPublishDir)/wwwroot/index.html.br" />
    <Delete Files="$(BlazorWasmPrerenderingPrevPublishDir)/wwwroot/index.html.gz" />
  </Target>

  <!--
  In .NET 6 SDK that wasm-tools workload is installed, "dotnet publish" causes calling "Publish" target twice.
  - https://github.com/dotnet/runtime/blob/v6.0.0-rc.2.21480.5/src/mono/wasm/build/README.md
  - https://github.com/dotnet/runtime/issues/60412
      
  To determine whether it is during the final "Publish" or not, it has to reference "WasmBuildingForNestedPublish" property is true or not.
  - https://github.com/dotnet/runtime/blob/v6.0.0-rc.2.21480.5/src/mono/wasm/build/WasmApp.targets#L109
  -->
  <Target Name="BlazorWasmPrerendering"
          AfterTargets="Publish"
          DependsOnTargets="BlazorWasmPrerendering_DefineProperties"
          Condition=" '$(BlazorWasmPrerendering)' != 'disable' AND '$(WasmBuildingForNestedPublish)' != 'true'">
    <Exec Command="dotnet &quot;$(BlazorWasmPrerenderingServerDll)&quot; -a &quot;$(BlazorWasmPrerenderingAssembly)&quot; -t &quot;$(BlazorWasmPrerenderingRootComponentType)&quot; --selectorofrootcomponent &quot;$(BlazorWasmPrerenderingRootComponentSelector)&quot; --selectorofheadoutletcomponent &quot;$(BlazorWasmPrerenderingHeadOutletComponentSelector)&quot; -p &quot;$(BlazorWasmPrerenderingPublishDir)&quot; -i &quot;$(BlazorWasmPrerenderingIntermediateDir)&quot; -m &quot;$(BlazorWasmPrerenderingMiddlewareArg)&quot; -f &quot;$(BlazorWasmPrerenderingTFM)&quot; --serviceworkerassetsmanifest &quot;$(ServiceWorkerAssetsManifest)&quot; -e &quot;$(BlazorWasmPrerenderingEnvironment)&quot; -o &quot;$(BlazorWasmPrerenderingOutputStyle)&quot; $(BlazorWasmPrerenderingKeepServerSwitch)" />
  </Target>
</Project>
